# スワイプLP分析ツール - 分析粒度要件

## 📋 提供されたファイルから抽出した要件

### 1. BigQueryテーブル構造（`events_flat_tbl`）

#### 主要カラム一覧

**基本情報:**
- `event_date`: イベント日付
- `event_timestamp`: イベントタイムスタンプ（UTC）
- `event_timestamp_jst`: イベントタイムスタンプ（JST）
- `event_name`: イベント名
- `user_pseudo_id`: ユーザーID
- `ga_session_id`: GAセッションID
- `ga_session_number`: GAセッション番号
- `session_id`: セッションID（user_pseudo_id + ga_session_id）

**ページ情報:**
- `page_location`: ページURL
- `page_referrer`: リファラー
- `page_path`: ページパス
- `prev_page_path`: 前ページパス
- `page_num_dom`: ページ番号（DOM）
- `original_page_num`: オリジナルページ番号

**滞在時間・パフォーマンス:**
- `stay_ms`: 滞在時間（ミリ秒）
- `total_duration_ms`: 合計滞在時間（ミリ秒）
- `load_time_ms`: 読込時間（ミリ秒）

**進行状況:**
- `max_page_reached`: 最大到達ページ
- `completion_rate`: 完了率
- `total_pages`: 総ページ数

**クリック情報:**
- `click_x_rel`: クリックX座標（相対）
- `click_y_rel`: クリックY座標（相対）
- `elem_tag`: 要素タグ
- `elem_id`: 要素ID
- `elem_classes`: 要素クラス

**スクロール:**
- `scroll_pct`: スクロール率

**UTM/トラフィック:**
- `utm_source`: UTMソース
- `utm_medium`: UTMメディア
- `utm_campaign`: UTMキャンペーン
- `utm_content`: UTMコンテンツ
- `device_type`: デバイスタイプ

**ナビゲーション:**
- `direction`: 移動方向（forward/backward）
- `navigation_method`: ナビゲーション方法（swipe/click/scroll）
- `link_url`: リンクURL
- `video_src`: 動画ソース

**A/Bテスト:**
- `session_variant`: セッションバリアント
- `presence_test_variant`: プレゼンステストバリアント
- `creative_test_variant`: クリエイティブテストバリアント
- `ab_variant`: A/Bバリアント
- `ab_test_target`: A/Bテスト対象
- `ab_test_type`: A/Bテストタイプ

**コンバージョン:**
- `cv_type`: コンバージョンタイプ（primary/micro）
- `cv_value`: コンバージョン値
- `value`: GA4一般値

---

### 2. Lookerダッシュボードで表示すべき分析項目

#### ページ1: 分単位データ計測

**KPI（上部）:**
- セッション数
- コンバージョン数
- コンバージョン率
- クリック数
- クリック率

**詳細メトリクス:**
- 平均到達ページ数
- 平均滞在時間
- FV残存率（First View残存率）
- 最終CTA到達率
- FV平均表示速度（ミリ秒）

**グラフ:**
- 過去24時間のデータ（テーブル形式）
- 過去24時間セッションCVRグラフ（時系列）

---

#### ページ2: スワイプ型LP分析レポート

**フィルター:**
- LP選択
- チャネル
- デバイス
- AorB（A/Bテスト）
- 期間指定

**KPI:**
- セッション数
- コンバージョン数
- FV残存率
- 最終CTA到達率
- 平均到達ページ数
- 平均滞在時間

**グラフ:**
- LP進行ファネル
- CVRとCTRの推移
- 日付別のCVとセッション

---

#### ページ3: ページ分析

**フィルター:**
- チャネル
- デバイス
- AorB
- 期間指定

**分析項目:**
- 滞在時間が短いページ
- 離脱率が高いページ
- 逆行パターン（遷移元ページ、遷移先ページ、回数）

---

#### ページ4: A/Bテスト分析

**フィルター:**
- デバイス
- AorB
- 期間指定

**分析項目:**
- A/Bテストマトリクス
- A/BテストCVR分析
- A/Bテスト（詳細）
- A/Bテスト最終CTA
- A/Bテストフローティングバナー
- A/Bテストポップアップ
- A/Bテスト FV残存率
- A/Bテストコンテンツ読了率

---

#### ページ5: 動画・スクロール分析

**フィルター:**
- デバイス
- 期間指定

**分析項目:**
- 動画視聴率ファネル
- 視聴率比較
- HTMLページ平均スクロール到達率
- 視聴率とCVRの相関性
- 視聴率ごとのデータ

---

#### ページ6: セグメント分析

**フィルター:**
- LP選択
- チャネル
- 参照元/メディア
- デバイス
- 年齢
- 性別
- 新規/再訪
- AorB
- 期間指定

**分析項目:**
- 時間・曜日ごとのCVR
- 年齢・性別ごとのCVR
- 地域分析（地域別のセッション、CV、CVR、ENG率、平均SS時間）
- チャネル分析（チャネル別のセッション、CV、CVR、ENG率、平均SS時間）

---

#### ページ7: デバイス・ブラウザ分析

**フィルター:**
- LP選択
- チャネル
- 参照元/メディア
- デバイス
- 年齢
- 性別
- 新規/再訪
- AorB
- 期間指定

**分析項目:**
- デバイス別のセッションとCVR
- ブラウザ別のセッションとCVR

---

#### ページ8: 月間分析レポート

**フィルター:**
- LP選択
- チャネル
- 参照元/メディア
- デバイス
- 年齢
- 性別
- 新規/再訪
- AorB
- 期間指定

**分析項目:**
- 月間推移
- 月間推移LP分析（FV残存率、最終CTA到達率、平均到達ページ数、平均滞在時間）

---

#### ページ9: アラート機能

**アラート例:**
- 3日間連続CVR下落+計-20%

**監視用:**
- セッション監視用
- CVR監視用

---

### 3. GA4 API の必要性について

**質問:** BQを通さずGA4直でLookerとつないでいるページもある。この場合GA4のAPIも必要になるか？

**回答:**

**結論: GA4 APIは不要です。**

理由:
1. **BigQueryに全データがエクスポートされている**
   - GA4のイベントデータは、すでにBigQueryの`analytics_396911244.events_*`テーブルにエクスポートされています。
   - 1時間ごとのスケジュールクエリで`events_flat_tbl`に統合されています。

2. **Lookerとの連携**
   - LookerがGA4と直接接続している場合でも、このアプリケーションはBigQueryのデータのみを使用します。
   - GA4 APIを使用する必要はありません。

3. **データの一元管理**
   - BigQueryに集約されたデータを使用することで、データの一貫性が保たれます。
   - GA4 APIを使用すると、データの重複や不整合が発生する可能性があります。

**推奨:**
- このアプリケーションは、BigQueryの`events_flat_tbl`テーブルのみを使用します。
- GA4 APIは使用しません。

---

### 4. 実装すべきグラフ・分析項目の全リスト

#### 基本KPI
1. セッション数
2. コンバージョン数
3. コンバージョン率
4. クリック数
5. クリック率

#### ページパフォーマンス
6. 平均到達ページ数
7. 平均滞在時間
8. FV残存率（First View残存率）
9. 最終CTA到達率
10. FV平均表示速度（ミリ秒）
11. ページ読込時間
12. スクロール率

#### ページ別分析
13. ページビュー数
14. ページ別滞在時間
15. ページ別離脱率
16. ページ別コンバージョン率
17. 滞在時間が短いページ（ランキング）
18. 離脱率が高いページ（ランキング）

#### 遷移分析
19. 逆行パターン（遷移元ページ、遷移先ページ、回数）
20. LP進行ファネル
21. ページ遷移フロー

#### セグメント分析
22. デバイス別（スマートフォン、パソコン、タブレット）
23. トラフィック元別（Google、Facebook、Instagram、Twitter、その他）
24. チャネル別（Direct、Organic Social、Referral、Organic Search、Unassigned）
25. 地域別（都道府県）
26. ブラウザ別（Chrome、Safari、Edge、Android Webview、Safari (in-app)、Samsung Internet）
27. 年齢別
28. 性別別
29. 新規/再訪別

#### 時系列分析
30. 時間・曜日ごとのCVR
31. 日付別のCVとセッション
32. CVRとCTRの推移
33. 月間推移
34. 月間推移LP分析（FV残存率、最終CTA到達率、平均到達ページ数、平均滞在時間）

#### A/Bテスト分析
35. A/Bテストマトリクス
36. A/BテストCVR分析
37. A/Bテスト別CVR推移
38. A/Bテスト最終CTA
39. A/Bテストフローティングバナー
40. A/Bテストポップアップ
41. A/Bテスト FV残存率
42. A/Bテストコンテンツ読了率

#### 動画・コンテンツ分析
43. 動画視聴率ファネル
44. 視聴率比較
45. HTMLページ平均スクロール到達率
46. 視聴率とCVRの相関性
47. 視聴率ごとのデータ

#### アラート・監視
48. CVR下落アラート（3日間連続-20%など）
49. セッション数監視
50. CVR監視

---

### 5. フィルター機能

すべてのグラフで、以下のフィルターを適用可能にする:

1. **LP選択** (複数選択可)
2. **チャネル** (複数選択可)
3. **参照元/メディア** (複数選択可)
4. **デバイス** (スマートフォン、パソコン、タブレット)
5. **年齢** (年齢層)
6. **性別** (男性、女性、不明)
7. **新規/再訪** (新規、再訪)
8. **AorB** (A/Bテストバリアント)
9. **期間指定** (過去7日、過去30日、過去90日、カスタム期間)

---

### 6. カスタムオーディエンス機能

ユーザーが即興で以下の条件を指定してオーディエンスを作成できる:

1. **滞在時間** (最小値、最大値)
2. **スクロール率** (最小値、最大値)
3. **到達ページ数** (最小値、最大値)
4. **コンバージョン達成** (はい/いいえ)
5. **デバイス** (複数選択可)
6. **トラフィック元** (複数選択可)
7. **A/Bテストバリアント** (複数選択可)

作成したオーディエンスに対して、以下の分析を実行:
- ユーザー数
- コンバージョン率
- 平均滞在時間
- 平均到達ページ数
- 時系列推移

---

### 7. SQL提案機能

ユーザーの分析要件に基づいて、実行可能なSQLクエリを提案する機能。

**例:**
- 「過去30日間のデバイス別コンバージョン率を教えて」
  → BigQueryで実行可能なSQLクエリを生成し、結果を可視化

---

### 8. 質問型チャット機能

システムが主導権を持ち、以下のような質問ボタンを提供:

1. 「このページの離脱率が高い理由は？」
2. 「A/Bテストの結果、どちらが優れていますか？」
3. 「コンバージョン率を改善するには？」
4. 「滞在時間が短いページの共通点は？」
5. 「デバイス別のパフォーマンス差は？」

ユーザーがボタンをクリックすると、Gemini 2.5 Proが分析結果を生成し、回答を表示。

---

## 📝 次のステップ

この要件をもとに、以下を実装します:

1. ✅ BigQueryテーブル構造に対応したデータ取得ロジック
2. ✅ 50項目以上のグラフ・分析項目の実装
3. ✅ 9種類のフィルター機能
4. ✅ カスタムオーディエンスビルダー
5. ✅ SQL提案機能
6. ✅ 質問型チャット機能（Gemini 2.5 Pro統合）
7. ✅ ページ画像表示機能
8. ✅ アラート・監視機能

---

## 🎯 実装優先度

### Phase 1: 基本機能（2週間）
- BigQueryデータ取得
- 基本KPI表示
- ページ別分析
- セグメント分析
- 時系列分析

### Phase 2: 高度な分析（2週間）
- A/Bテスト分析
- 動画・コンテンツ分析
- 遷移分析
- カスタムオーディエンスビルダー

### Phase 3: AI機能（1週間）
- Gemini 2.5 Pro統合
- 質問型チャット機能
- SQL提案機能
- アラート機能

### Phase 4: UI/UX改善（1週間）
- ページ画像表示
- フィルター機能の最適化
- レスポンシブデザイン
- ドキュメント作成

---

**合計開発期間: 6～8週間**

