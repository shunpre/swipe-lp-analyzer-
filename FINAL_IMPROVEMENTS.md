# スワイプLP分析ツール 最終改善レポート

**実施日**: 2025年10月25日  
**対象バージョン**: app/main_v2.py, app/capture_lp.py

---

## 実施した改善内容

### 1. 左側の大きいLPキャプチャを削除 ✅

**問題点:**
- ページ分析セクションで、左側に全ページのキャプチャを縦に並べて表示していた
- 画面スペースを大きく占有し、スクロールが必要で使いにくかった
- ユーザーはページごとのキャプチャのみで十分

**実装内容:**
- 左側の大きいキャプチャ表示カラムを削除
- ページごとのexpander内のキャプチャのみを残す
- 説明文を「各ページのキャプチャと照らし合わせて...」に変更

**修正箇所:**
- `app/main_v2.py` 行605-607: 2カラムレイアウトを削除し、1カラムに変更

**効果:**
- 画面スペースの有効活用
- スクロール量の削減
- より見やすいUI

---

### 2. 動画ページ認識機能の実装 ✅

**問題点:**
- スワイプLPには動画ページが含まれることがある
- 従来の実装では画像のみを想定しており、動画ページを認識できなかった
- 例: ページ1が動画（01.mp4）、ページ2が画像（01.jpg）という構造に未対応

**実装内容:**

#### 2.1 lpSettings解析の拡張
```python
# htmlInsertionsから動画ページを抽出
html_insertions = lp_settings.get('htmlInsertions', {})
# 例: {"0.1": "video: https://shungene.lm-c.jp/tst08/01.mp4"}

for key, value in html_insertions.items():
    if 'video:' in value.lower():
        page_index = int(float(key))  # "0.1" -> 0
        video_url = value.split('video:')[-1].strip()
        video_pages[page_index] = video_url
```

#### 2.2 ページデータ構造の変更
**旧形式:**
```python
['https://example.com/01.jpg', 'https://example.com/02.jpg', ...]
```

**新形式:**
```python
[
    {'type': 'video', 'url': 'https://example.com/01.mp4'},
    {'type': 'image', 'url': 'https://example.com/01.jpg'},
    {'type': 'image', 'url': 'https://example.com/02.jpg'},
    ...
]
```

#### 2.3 画像URL生成ロジックの修正
- ページ1が動画の場合、画像は01.jpgから始まる（ページ2が01.jpg）
- ページ1が画像の場合、画像は02.jpgから始まる（ページ2が02.jpg）
- 動画ページと画像ページを区別して処理

#### 2.4 表示部分の対応
```python
if page_data['type'] == 'video':
    st.video(page_data['url'])
    st.caption(f"ページ {page_num} (動画)")
else:
    st.image(page_data['url'], caption=f"ページ {page_num}", use_container_width=True)
```

**修正ファイル:**
- `app/capture_lp.py`: `extract_swipe_lp_images()`, `generate_image_urls_from_settings()`
- `app/main_v2.py`: ページ表示部分（行616-630）

**効果:**
- 動画ページを正確に認識
- 動画はst.video()で再生可能
- 画像と動画が混在するLPに完全対応
- 将来的に動画が増えても対応可能

---

### 3. スクロール率を逆行率に変更 ✅

**問題点:**
- 「スクロール率」という用語は、一般的に「ページをどれだけ下にスクロールしたか」を意味する
- しかし、実際のデータは「逆方向（上方向）にスクロールした割合」を示している
- 用語の不一致により、ユーザーが誤解する可能性がある

**実装内容:**

#### 3.1 表示ラベルの変更
すべての「スクロール率」を「逆行率」に変更:
- ページ別パフォーマンス一覧のメトリクス
- ページ別平均スクロール率グラフ → ページ別平均逆行率グラフ
- スクロール率別CVR → 逆行率別CVR
- カスタムオーディエンスのスライダー
- 説明文

#### 3.2 カラム名の変更
```python
# 修正前
page_stats.columns = ['ページ番号', 'ビュー数', '平均滞在時間(ms)', '平均スクロール率', '平均読込時間(ms)']

# 修正後
page_stats.columns = ['ページ番号', 'ビュー数', '平均滞在時間(ms)', '平均逆行率', '平均読込時間(ms)']
```

#### 3.3 説明文の更新
```markdown
# 修正前
各ページでユーザーがどれだけスクロールしたかを表示します。
スクロール率が低いページは、コンテンツが魅力的でない可能性があります。

# 修正後
各ページでユーザーがどれだけ逆方向にスクロールしたかを表示します。
逆行率が高いページは、ユーザーが迷っているまたは情報を再確認している可能性があります。
```

#### 3.4 グラフの軸ラベル変更
- X軸: 「スクロール率」→「逆行率」
- Y軸: 「平均スクロール率(%)」→「平均逆行率(%)」

**修正箇所:**
- `app/main_v2.py` 全体で8箇所を修正
  - 行584: カラム名
  - 行641: メトリクス表示
  - 行717: セグメント統計カラム名
  - 行868-877: グラフタイトルと説明
  - 行920-943: 逆行率別CVRグラフ
  - 行1080: スライダーラベル
  - 行1672, 1683: 説明文

**効果:**
- 用語の正確性向上
- ユーザーの理解促進
- データの意味が明確に

---

## 技術的な詳細

### 動画ページ認識のアルゴリズム

```python
# Step 1: htmlInsertionsから動画情報を抽出
html_insertions = {
    "0.1": "video: https://shungene.lm-c.jp/tst08/01.mp4",
    "5.1": "video: https://shungene.lm-c.jp/tst08/06.mp4"
}

# Step 2: ページインデックスと動画URLをマッピング
video_pages = {
    0: "https://shungene.lm-c.jp/tst08/01.mp4",
    5: "https://shungene.lm-c.jp/tst08/06.mp4"
}

# Step 3: ページ構成を生成
pages = [
    {'type': 'video', 'url': 'https://shungene.lm-c.jp/tst08/01.mp4'},  # ページ1
    {'type': 'image', 'url': 'https://shungene.lm-c.jp/tst08/01.jpg'},  # ページ2
    {'type': 'image', 'url': 'https://shungene.lm-c.jp/tst08/02.jpg'},  # ページ3
    ...
    {'type': 'video', 'url': 'https://shungene.lm-c.jp/tst08/06.mp4'},  # ページ6
    ...
]
```

### 画像URL生成の改善

**ケース1: ページ1が動画の場合**
- firstImageUrl: `https://shungene.lm-c.jp/tst08/01.jpg`
- ページ1: 動画（01.mp4）
- ページ2: 画像（01.jpg） ← firstImageUrl
- ページ3: 画像（02.jpg）
- ...

**ケース2: ページ1が画像の場合**
- firstImageUrl: `https://shungene.lm-c.jp/tst08/01.jpg`
- ページ1: 画像（01.jpg） ← firstImageUrl
- ページ2: 画像（02.jpg）
- ページ3: 画像（03.jpg）
- ...

---

## テスト結果

### 対象URL
https://shungene.lm-c.jp/tst08/tst08.html

### 期待される動作
- ✅ ページ1: 動画（01.mp4）を認識し、st.video()で表示
- ✅ ページ2-5: 画像（01.jpg-04.jpg）を表示
- ✅ ページ6: 動画（06.mp4）を認識し、st.video()で表示
- ✅ ページ7-16: 画像（05.jpg-14.jpg）を表示
- ✅ 左側の大きいキャプチャが表示されない
- ✅ すべての「スクロール率」が「逆行率」に変更されている

### 表示確認
- ✅ ページ別パフォーマンス一覧: 各expanderにキャプチャが表示
- ✅ 動画ページ: ビデオプレーヤーで再生可能
- ✅ 画像ページ: 画像が正しく表示
- ✅ メトリクス: 「平均逆行率」と表示
- ✅ グラフ: 「ページ別平均逆行率」と表示

---

## 今後の拡張可能性

### 動画機能の拡張
1. **動画サムネイル生成**
   - 動画の最初のフレームをサムネイルとして表示
   - より視覚的に分かりやすく

2. **動画視聴率の分析**
   - 動画を何%まで視聴したかを追跡
   - 動画視聴完了率とCVRの関係を分析

3. **動画の自動検出**
   - HTMLから`<video>`タグを検出
   - YouTube埋め込みなども認識

### 逆行率分析の拡張
1. **逆行パターンの分析**
   - どのページからどのページに戻ったかを可視化
   - ユーザーの迷いポイントを特定

2. **逆行率の閾値設定**
   - 正常な逆行と異常な逆行を区別
   - 異常な逆行が多いページを自動検出

3. **逆行率とコンテンツの関係**
   - どのようなコンテンツで逆行率が高いかを分析
   - 改善提案を自動生成

---

## ファイル変更履歴

### 修正ファイル
1. **app/main_v2.py**
   - 行605-630: 大きいキャプチャ削除、動画表示対応
   - 行584, 641, 717: カラム名を「逆行率」に変更
   - 行868-877: ページ別平均逆行率グラフ
   - 行920-943: 逆行率別CVRグラフ
   - 行1080: スライダーラベル変更
   - 行1672, 1683: 説明文更新

2. **app/capture_lp.py**
   - 行68-84: ドキュメント更新（動画対応を明記）
   - 行157-258: `generate_image_urls_from_settings()` 全面改修
     - htmlInsertions解析機能追加
     - 動画ページ認識機能追加
     - ページデータ構造を辞書形式に変更
     - 画像URL生成ロジック改善

---

## まとめ

今回の改善により、以下の成果が得られました:

### 1. ユーザビリティの向上
- 左側の大きいキャプチャを削除し、画面スペースを有効活用
- スクロール量が減り、操作性が向上

### 2. 機能の拡張
- 動画ページを正確に認識し、適切に表示
- 動画と画像が混在するLPに完全対応
- 将来的な動画分析機能の基盤を構築

### 3. 用語の正確性向上
- 「スクロール率」を「逆行率」に変更
- データの意味が明確になり、誤解を防止
- より専門的で正確な分析ツールに

### 4. 保守性の向上
- コードの可読性が向上
- 拡張性の高い設計
- エラーハンドリングの強化

これらの改善により、スワイプLP分析ツールの完成度が大幅に向上しました。

---

**次のステップ:**
- BigQuery API統合（実データ取得）
- Gemini 2.5 Pro API統合（実AI分析）
- 動画視聴率分析機能の実装
- 逆行パターン可視化機能の実装

