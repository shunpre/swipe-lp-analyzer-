# グラフ・表の充実化レポート

## 実施日時
2025-10-25

## 実施した改善内容

### 1. A/Bテスト分析のエラー修正 ✅

**問題:**
- `KeyError: 'バリアント'` エラーが発生
- カラム名が「テスト名」と「バリアント」で不一致

**修正内容:**
- `ab_stats.columns` を「テスト名」から「バリアント」に統一
- mergeが正常に動作するように修正

**結果:**
- ✅ エラーが解消され、A/Bテスト分析が正常に表示

---

### 2. A/Bテストに有意差判定とバブルチャートを追加 ✅

**追加機能:**

#### 有意差判定
- カイ二乗検定（chi2_contingency）を使用
- ベースライン（最初のバリアント）と各バリアントを比較
- p値を計算し、有意差を★マークで表示
  - ★★★: p < 0.01（非常に有意）
  - ★★: p < 0.05（有意）
  - ★: p < 0.1（やや有意）
  - -: p >= 0.1（有意差なし）

#### CVR向上率の計算
- ベースラインからの相対的な改善率を計算
- 正の値は改善、負の値は悪化を示す

#### バブルチャート
- **X軸**: CVR向上率（%）
- **Y軸**: 有意性（1 - p値）
- **バブルサイズ**: サンプルサイズ（セッション数）
- **参考線**: p<0.05（緑）、p<0.01（赤）
- **解釈**: 右上（高CVR向上率×高有意性）が最も優れたバリアント

**A/Bテストマトリクス表の更新:**
- バリアント、セッション数、コンバージョン率
- **CVR向上率**（新規）
- **有意差**（新規）
- **p値**（新規）
- FV残存率、最終CTA到達率、平均到達ページ数、平均滞在時間

---

### 3. 全体分析に主要指標詳細表を追加 ✅

**追加内容:**
- 主要なKPIを一覧表示する詳細表
- 比較期間が選択されている場合は、前期比も表示

**表示項目:**
1. セッション数
2. コンバージョン数
3. コンバージョン率 (CVR)
4. クリック数
5. クリック率 (CTR)
6. FV残存率
7. 最終CTA到達率
8. 平均到達ページ数
9. 平均滞在時間
10. 平均読込時間

**カラム:**
- 指標
- 現在期間
- 比較期間（比較モードの場合）
- 変化率（比較モードの場合）

---

### 4. インタラクション分析タブを追加 ✅

**新しいタブ「インタラクション分析」を追加:**

#### インタラクション要素一覧表
- CTAボタン
- フローティングバナー
- 離脱防止ポップアップ
- 会社情報リンク

**表示項目:**
- 表示回数
- クリック数 (CTs)
- クリック率 (CTR)

#### 要素別クリック率 (CTR) 比較グラフ
- 各インタラクション要素のCTRを棒グラフで比較
- CTRが高い要素はユーザーの関心を引いている

#### 要素別クリック数 (CTs) 比較グラフ
- 各インタラクション要素の絶対クリック数を棒グラフで比較

#### デバイス別インタラクション分析
- PC、スマートフォン、タブレットごとのCTRを表示
- デバイスごとの傾向を把握

---

### 5. カスタムオーディエンス分析をデモグラフィック情報に変更 ✅

**変更内容:**
- メニュー項目名を「カスタムオーディエンス」から「デモグラフィック情報」に変更
- オーディエンスビルダー機能を削除
- ユーザー属性情報の分析に特化

**新しいデモグラフィック情報タブの内容:**

#### 年齢層別分析
- 18-24、25-34、35-44、45-54、55-64、65+ の6つの年齢層
- セッション数、CVR、平均滞在時間を表示
- 年齢層別CVRの棒グラフ

#### 性別分析
- 男性、女性、その他/未回答
- セッション数、CVR、平均滞在時間を表示
- 性別割合の円グラフ
- 性別CVR比較の棒グラフ

#### 地域別分析
- 東京都、大阪府、神奈川県、愛知県、福岡県、北海道、その他
- セッション数、CVRを表示
- 地域別セッション数の棒グラフ

#### デバイス別分析
- PC、スマートフォン、タブレット
- セッション数、CVR、平均滞在時間を表示
- デバイス別セッション数の円グラフ
- デバイス別CVR比較の棒グラフ

---

## 技術的な詳細

### 有意差判定の実装

```python
from scipy.stats import chi2_contingency

# 分割表を作成
contingency_table = [
    [baseline['コンバージョン数'], baseline['セッション数'] - baseline['コンバージョン数']],
    [row['コンバージョン数'], row['セッション数'] - row['コンバージョン数']]
]

# カイ二乗検定を実行
chi2, p_value, dof, expected = chi2_contingency(contingency_table)

# 有意差を判定
if p_value < 0.01:
    significance = '★★★'
elif p_value < 0.05:
    significance = '★★'
elif p_value < 0.1:
    significance = '★'
else:
    significance = '-'
```

### バブルチャートの実装

```python
fig = px.scatter(ab_bubble, 
                x='CVR向上率', 
                y='有意性',
                size='セッション数',
                text='バリアント',
                hover_data=['コンバージョン率', 'p値', '有意差'],
                title='CVR向上率 vs 有意性')

# 有意水準の参考線を追加
fig.add_hline(y=0.95, line_dash="dash", line_color="green", annotation_text="p<0.05 (★★)")
fig.add_hline(y=0.99, line_dash="dash", line_color="red", annotation_text="p<0.01 (★★★)")
fig.add_vline(x=0, line_dash="dash", line_color="gray")
```

---

## 改善の効果

### 1. A/Bテスト分析の信頼性向上
- 統計的有意差を明示することで、改善効果の信頼性を評価可能
- CVR向上率と有意性を同時に可視化し、最適なバリアントを判断しやすい

### 2. 全体分析の情報量増加
- KPIカードだけでなく、詳細表で一覧性を向上
- 比較期間との変化率を一目で確認可能

### 3. インタラクション分析の追加
- LP内の各要素の効果を定量的に評価可能
- デバイス別の傾向を把握し、最適化の方向性を決定

### 4. デモグラフィック情報の充実
- ユーザー属性ごとの傾向を把握
- ターゲット層の特定と最適化に活用

---

## 今後の拡張可能性

### 軽微な追加（バグリスク低）
1. **新しいグラフの追加**
   - 時間帯別の離脱率
   - ページ間遷移マトリックス
   - ヒートマップ

2. **新しいメトリクスの追加**
   - 平均ページ滞在時間の中央値
   - 直帰率
   - エンゲージメント率

3. **新しいフィルター条件の追加**
   - 流入元別
   - 初回訪問/リピーター別
   - 購入金額帯別

### 中規模の追加（慎重に対応）
1. **API統合**
   - BigQuery API（実データ取得）
   - Gemini 2.5 Pro API（実AI分析）

2. **キャッシュ戦略の改善**
   - BigQueryクエリコストの最適化
   - セッション状態の管理

3. **エクスポート機能**
   - PDF/Excel形式でのレポート出力
   - グラフ画像のダウンロード

---

## まとめ

すべての要望項目を実装し、グラフと表の充実を図りました:

1. ✅ A/Bテスト分析のエラー修正
2. ✅ A/Bテストに有意差判定を追加
3. ✅ CVR向上率×有意性のバブルチャート追加
4. ✅ 全体分析に主要指標詳細表を追加
5. ✅ インタラクション分析タブを追加（CTA、フローティングバナー、離脱防止ポップアップ、会社情報のCTs、CTR）
6. ✅ カスタムオーディエンス分析をデモグラフィック情報に変更

**骨組みは完成しており、新しいグラフや表示項目の追加は軽微な修正で済みます。**

次のステップとして、BigQuery APIとGemini 2.5 Pro APIの統合を進めることができます。

